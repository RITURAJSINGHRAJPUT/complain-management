<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File a Complaint</title>
    <link rel="stylesheet" href="styles.css">
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body>
    <nav>
        <h1>College Complaint Management</h1>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="complaint.html">File a Complaint</a></li>
            <li><a href="complaints.html">View Complaints</a></li>
        </ul>
    </nav>

    <section>
        <h2>Verify Your Student ID</h2>
        <video id="camera" autoplay></video>
        <button class="btn" onclick="captureImage()">Scan ID Card</button>
        <canvas id="canvas" style="display:none;"></canvas>
        <p id="verificationStatus">Please scan your ID.</p>
    </section>

    <section id="complaintSection" style="display:none;">
        <h2>File a Complaint</h2>
        <p><strong>Reference Number:</strong> <span id="refNo"></span></p>
        <form id="complaintForm">
            <textarea id="complaint" placeholder="Describe your complaint" required></textarea>
            <button type="submit" class="btn">Submit Complaint</button>
        </form>
    </section>

    <script>
        let refImagePath = "id_template.jpg";  // Add your template ID image here
        let isOpencvLoaded = false;

        // Load OpenCV
        function onOpenCvReady() {
            isOpencvLoaded = true;
            console.log("OpenCV Loaded Successfully!");
        }

        // Start Camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                document.getElementById("camera").srcObject = stream;
            });

        function captureImage() {
            let video = document.getElementById("camera");
            let canvas = document.getElementById("canvas");
            let ctx = canvas.getContext("2d");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            let imageURL = canvas.toDataURL("image/png");
            verifyID(imageURL);
        }

        function verifyID(imageURL) {
            if (!isOpencvLoaded) {
                alert("Error: OpenCV is still loading. Try again in a few seconds.");
                return;
            }

            let userImg = cv.imread(imageURL);
            let refImg = cv.imread(refImagePath);

            let userGray = new cv.Mat();
            let refGray = new cv.Mat();

            cv.cvtColor(userImg, userGray, cv.COLOR_RGBA2GRAY);
            cv.cvtColor(refImg, refGray, cv.COLOR_RGBA2GRAY);

            let diff = new cv.Mat();
            cv.absdiff(userGray, refGray, diff);

            let nonZero = cv.countNonZero(diff);
            console.log("Difference Score:", nonZero);

            if (nonZero < 10000) { // Adjust threshold for better accuracy
                document.getElementById("verificationStatus").innerText = "✅ ID Verified!";
                document.getElementById("complaintSection").style.display = "block";
                document.getElementById("refNo").innerText = generateRefNo();
            } else {
                document.getElementById("verificationStatus").innerText = "❌ ID Verification Failed!";
            }

            userImg.delete(); refImg.delete();
            userGray.delete(); refGray.delete();
            diff.delete();
        }

        function generateRefNo() {
            return "COMP" + Math.floor(100000 + Math.random() * 900000);
        }

        document.getElementById("complaintForm").addEventListener("submit", function(event) {
            event.preventDefault();
            let complaintText = document.getElementById("complaint").value;
            let refNo = document.getElementById("refNo").innerText;

            let complaints = JSON.parse(localStorage.getItem("complaints")) || [];
            complaints.push({ refNo, complaint: complaintText, status: "Pending" });

            localStorage.setItem("complaints", JSON.stringify(complaints));
            alert("Complaint submitted successfully!\nReference No: " + refNo);
            this.reset();
        });
    </script>
</body>
</html>
